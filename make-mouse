#!/bin/bash
# Exit on error
set -e


CWD=$(pwd)

# Original Android build logic
# NDK path - update this to match your setup
API=30
TARGET=armv7a-linux-androideabi
TOOLCHAIN=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64

# Create build directory in current working directory
BUILD_DIR="$CWD/build"
mkdir -p "$BUILD_DIR"

echo "=== Building for Android $API ($TARGET) ==="

# Download and extract libevdev
cd "$BUILD_DIR"
if [[ ! -f "install/include/libevdev-1.0/libevdev/libevdev.h" || ! -f "install/include/libevdev-1.0/libevdev/libevdev-uinput.h" ]]; then
    if [ ! -f "libevdev-1.13.6.tar.xz" ]; then
        echo "Downloading libevdev..."
        wget -nv https://www.freedesktop.org/software/libevdev/libevdev-1.13.6.tar.xz
    fi

    if [ ! -d "libevdev-1.13.6" ]; then
        echo "Extracting libevdev..."
        tar xf libevdev-1.13.6.tar.xz
    fi

    # Build libevdev
    cd "$BUILD_DIR/libevdev-1.13.6"
    echo "Configuring libevdev..."

    # Configure with Android toolchain
    CC="$TOOLCHAIN/bin/clang --target=$TARGET$API" \
        CXX="$TOOLCHAIN/bin/clang++ --target=$TARGET$API" \
        AR="$TOOLCHAIN/bin/llvm-ar" \
        RANLIB="$TOOLCHAIN/bin/llvm-ranlib" \
        STRIP="$TOOLCHAIN/bin/llvm-strip" \
        ./configure --host=$TARGET --prefix="$BUILD_DIR/install" \
        --disable-shared --enable-static

    echo "Building libevdev..."
    make -j$(nproc)
    make install

fi
# Now compile the main.c program
echo "Building mouse application..."
# Assuming main.c is in the current directory
cd "$CWD"

# Add local libevdev source include for fallback header
"$TOOLCHAIN/bin/clang" --target=$TARGET$API \
    -I"$BUILD_DIR/install/include" \
    -I"$BUILD_DIR/install/include/libevdev-1.0" \
    -I"$BUILD_DIR/libevdev-1.13.6/libevdev" \
    -L"$BUILD_DIR/install/lib" \
    -o "$BUILD_DIR/mouse" *.c \
    -levdev

# Strip binary
"$TOOLCHAIN/bin/llvm-strip" "$BUILD_DIR/mouse"

echo "=== Build completed ==="
echo "Binary is at: $BUILD_DIR/mouse"

# make a zip archive with mouse, ../properties/*
if [ -d "$CWD/build/bundle" ]; then
    rm -r "$CWD/build/bundle"
fi
mkdir -p "$CWD/build/bundle"
cd "$CWD/build/bundle"
cp -r $CWD/properties/* .
cp "$CWD/build/mouse" .
zip -r -FS FlipMouse.zip .
